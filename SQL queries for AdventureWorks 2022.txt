Database: AdventureWorks2022



WITH EmployeeCTE AS (
    SELECT 
        e.[BusinessEntityID],
        e.[OrganizationLevel],
        e.[JobTitle],
        YEAR(e.[BirthDate]) AS [BirthYear],
        e.[MaritalStatus],
        e.[Gender],
        e.[HireDate],
        e.[SalariedFlag],
        e.[VacationHours],
        e.[SickLeaveHours],
        eph.[Rate],
        eph.[PayFrequency]
    FROM 
        [AdventureWorks2022].[HumanResources].[Employee] AS e
    LEFT JOIN
        [AdventureWorks2022].[HumanResources].[EmployeePayHistory] AS eph
        ON e.[BusinessEntityID] = eph.[BusinessEntityID]
),
EmployeeDepartmentHistoryCTE AS (
    SELECT 
        edh.[BusinessEntityID],
        d.[Name] AS [DepartmentName],
        d.[GroupName] AS [DepartmentGroupName],  -- исправлена опечатка
        sh.[Name] AS [ShiftName],
        edh.[StartDate],
        edh.[EndDate]
    FROM 
        [AdventureWorks2022].[HumanResources].[EmployeeDepartmentHistory] AS edh
    LEFT JOIN
        [AdventureWorks2022].[HumanResources].[Department] AS d
        ON edh.[DepartmentID] = d.[DepartmentID]
    LEFT JOIN
        [AdventureWorks2022].[HumanResources].[Shift] AS sh
        ON edh.[ShiftID] = sh.[ShiftID]
),
HumanResourcesCTE AS (
    SELECT 
        edh.*,
        e.[OrganizationLevel],
        e.[JobTitle],
        e.[BirthYear],
        e.[MaritalStatus],
        e.[Gender],
        e.[HireDate],
        e.[SalariedFlag],
        e.[VacationHours],
        e.[SickLeaveHours],
        e.[Rate],
        e.[PayFrequency]
    FROM 
        EmployeeDepartmentHistoryCTE AS edh
    LEFT JOIN 
        EmployeeCTE AS e
    ON 
        edh.[BusinessEntityID] = e.[BusinessEntityID]
)

	SELECT sp.[BusinessEntityID]
      ,st.[Name] AS TerritoryName
	  ,st.[Group] AS TerritoryGroup
      ,[SalesQuota]
      ,[Bonus]
      ,[CommissionPct]
      ,sp.[SalesYTD]
      ,sp.[SalesLastYear]
	  ,hr_cte.*
	FROM [AdventureWorks2022].[Sales].[SalesPerson] AS sp
	LEFT JOIN 
		[AdventureWorks2022].[Sales].[SalesTerritory] AS st
		ON sp.[TerritoryID] = st.[TerritoryID]
	LEFT JOIN
		HumanResourcesCTE AS hr_cte
		ON sp.[BusinessEntityID] = hr_cte.[BusinessEntityID]











WITH SalesOrderDetailCTE AS (
	SELECT 
		sod.[SalesOrderID],
		sod.[SalesOrderDetailID],
		sod.[OrderQty],
		sod.[ProductID],
		sod.[SpecialOfferID],
		sod.[UnitPrice],
		sod.[UnitPriceDiscount],
		sod.[LineTotal],
		p.[Name] AS ProductName,
		p.[ProductNumber],
		pm.[Name] AS ProductModelName,
		p.[Color],
		p.[SafetyStockLevel],
		p.[StandardCost],
		p.[ListPrice],
		pc.[Name] AS ProductCategoryName,
		ps.[Name] AS ProductSubcategoryName
	FROM 
		[AdventureWorks2022].[Sales].[SalesOrderDetail] AS sod
	-- Join with Product table
	LEFT JOIN 
		[AdventureWorks2022].[Production].[Product] AS p
		ON sod.[ProductID] = p.[ProductID]
	-- Join with ProductSubcategory table
	LEFT JOIN 
		[AdventureWorks2022].[Production].[ProductSubcategory] AS ps
		ON p.[ProductSubcategoryID] = ps.[ProductSubcategoryID]
	-- Join with ProductCategory table
	LEFT JOIN 
		[AdventureWorks2022].[Production].[ProductCategory] AS pc
		ON ps.[ProductCategoryID] = pc.[ProductCategoryID]
	-- Join with ProductModel table
	LEFT JOIN [AdventureWorks2022].[Production].[ProductModel] AS pm
		ON p.[ProductModelID] = pm.[ProductModelID]
)

-- Main query with RIGHT JOIN
SELECT
    soh.[SalesOrderID],
    -- Extract day, month, year from OrderDate
    DAY(soh.[OrderDate]) AS [OrderDay],
    MONTH(soh.[OrderDate]) AS [OrderMonth],
    YEAR(soh.[OrderDate]) AS [OrderYear],
    DATENAME(MONTH, soh.[OrderDate]) AS [OrderMonthName], -- Month name for OrderDate

    -- Extract day, month, year from DueDate
    DAY(soh.[DueDate]) AS [DueDay],
    MONTH(soh.[DueDate]) AS [DueMonth],
    YEAR(soh.[DueDate]) AS [DueYear],
    DATENAME(MONTH, soh.[DueDate]) AS [DueMonthName], -- Month name for DueDate

    -- Extract day, month, year from ShipDate
    DAY(soh.[ShipDate]) AS [ShipDay],
    MONTH(soh.[ShipDate]) AS [ShipMonth],
    YEAR(soh.[ShipDate]) AS [ShipYear],
    DATENAME(MONTH, soh.[ShipDate]) AS [ShipMonthName], -- Month name for ShipDate

    soh.[SalesOrderNumber],
    soh.[PurchaseOrderNumber],
    soh.[CustomerID],
    soh.[SalesPersonID],
    soh.[BillToAddressID],
    soh.[ShipToAddressID],
    sm.[Name] AS [ShipMethodName],
    cc.[CardType],
    soh.[CurrencyRateID],
    soh.[SubTotal],
    soh.[TaxAmt],
    soh.[Freight],
    soh.[TotalDue],
    st.[Name] AS [TerritoryName],
    st.[Group] AS [TerritoryGroup],
    
    -- Concatenate all sales reasons into one string
    STRING_AGG(sr.[Name], ', ') AS SalesReasonNames,
    
    -- Additional fields from SalesOrderDetailCTE
    sodcte.ProductName,
    sodcte.ProductNumber,
    sodcte.ProductModelName,
    sodcte.Color,
    sodcte.SafetyStockLevel,
    sodcte.StandardCost,
    sodcte.ListPrice,
    sodcte.ProductCategoryName,
    sodcte.ProductSubcategoryName
FROM [AdventureWorks2022].[Sales].[SalesOrderHeader] AS soh
    
RIGHT JOIN 
    SalesOrderDetailCTE AS sodcte
    ON soh.[SalesOrderID] = sodcte.[SalesOrderID] 
LEFT JOIN 
    [AdventureWorks2022].[Sales].[SalesTerritory] AS st
    ON soh.[TerritoryID] = st.[TerritoryID]
LEFT JOIN 
    [AdventureWorks2022].[Purchasing].[ShipMethod] AS sm
    ON soh.[ShipMethodID] = sm.[ShipMethodID]
LEFT JOIN
    [AdventureWorks2022].[Sales].[SalesOrderHeaderSalesReason] AS sohsr
    ON soh.[SalesOrderID] = sohsr.[SalesOrderID]
LEFT JOIN
    [AdventureWorks2022].[Sales].[SalesReason] AS sr
    ON sohsr.[SalesReasonID] = sr.[SalesReasonID]
LEFT JOIN
    [AdventureWorks2022].[Sales].[CreditCard] AS cc
    ON soh.[CreditCardID] = cc.[CreditCardID]
GROUP BY
    soh.[SalesOrderID],
    soh.[OrderDate],
    soh.[DueDate],
    soh.[ShipDate],
    soh.[SalesOrderNumber],
    soh.[PurchaseOrderNumber],
    soh.[CustomerID],
    soh.[SalesPersonID],
    soh.[BillToAddressID],
    soh.[ShipToAddressID],
    sm.[Name],
    cc.[CardType],
    soh.[CurrencyRateID],
    soh.[SubTotal],
    soh.[TaxAmt],
    soh.[Freight],
    soh.[TotalDue],
    st.[Name],
    st.[Group],
    sodcte.ProductName,
    sodcte.ProductNumber,
    sodcte.ProductModelName,
    sodcte.Color,
    sodcte.SafetyStockLevel,
    sodcte.StandardCost,
    sodcte.ListPrice,
    sodcte.ProductCategoryName,
    sodcte.ProductSubcategoryName;














SELECT 
    poh.[PurchaseOrderID],
    poh.[EmployeeID],
    v.[Name] AS VendorName,
    v.[CreditRating] AS VendorCreditRating,
    sm.[Name] AS ShipMethodName,
    sm.[ShipBase],
    sm.[ShipRate],
    poh.[SubTotal],
    poh.[TaxAmt],
    poh.[Freight],
    poh.[TotalDue],
    pod.[OrderQty],
    pod.[ProductID],
    pod.[UnitPrice],
    pod.[LineTotal]
FROM 
    [AdventureWorks2022].[Purchasing].[PurchaseOrderHeader] AS poh
-- Join with Vendor table
INNER JOIN 
    [AdventureWorks2022].[Purchasing].[Vendor] AS v
    ON poh.[VendorID] = v.[BusinessEntityID]
-- Join with ShipMethod table
INNER JOIN 
    [AdventureWorks2022].[Purchasing].[ShipMethod] AS sm
    ON poh.[ShipMethodID] = sm.[ShipMethodID]
-- Join with PurchaseOrderDetail table
INNER JOIN 
    [AdventureWorks2022].[Purchasing].[PurchaseOrderDetail] AS pod
    ON poh.[PurchaseOrderID] = pod.[PurchaseOrderID];